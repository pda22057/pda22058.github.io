<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ocean Survival — A‑Frame</title>
  <!-- A‑Frame core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- aframe-extras: includes useful components like animation-mixer and ocean -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.7.0/dist/aframe-extras.min.js"></script>
  <style>
    body { margin:0; }
    .hud { position: fixed; left: 12px; top: 12px; font: 14px/1.4 system-ui, sans-serif; color: #fff; z-index: 10; }
    .hud .pill { background: rgba(0,0,0,.45); padding: 8px 10px; border-radius: 10px; margin-bottom: 6px; }
  </style>
</head>
<body>
  <div class="hud">
    <div class="pill">WASD to move • Mouse to look • Enter VR if supported</div>
    <div class="pill">Avoid the glowing red circles. Stay safe!</div>
    <div id="status" class="pill">Status: Ready</div>
  </div>

  <a-scene renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
           background="color: #03050a">
    <!-- Assets -->
    <a-assets timeout="30000"></a-assets>

    <!-- Lighting for photoreal vibe -->
    <a-entity light="type: directional; intensity: 0.4; castShadow: true" position="2 5 1"></a-entity>
    <a-entity light="type: hemisphere; intensity: 0.6; groundColor: #0b2233; color: #88aaff"></a-entity>

    <!-- Dark, moody sky -->
    <a-sky color="#04070d"></a-sky>

    <!-- Ocean surface using aframe-extras ocean component (infinite animated waves) -->
    <a-entity id="ocean" ocean="density: 20; width: 200; height: 200; amplitude: 0.15; speed: 0.5; color: #0a1e2b" position="0 0 0"></a-entity>

    <!-- Player rig at water surface -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="player" camera look-controls wasd-controls></a-entity>
    </a-entity>

    <!-- Bottle collectibles (replace primitive with your GLB later) -->
    <a-entity id="collectibles"></a-entity>

    <!-- Target spawner controller -->
    <a-entity id="game" game-manager target-spawner="intervalMin: 4000; intervalMax: 7000; radius: 25"></a-entity>
  </a-scene>

  <script>
  // ===== Utility: random in range
  function randRange(min,max){ return Math.random()*(max-min)+min; }

  // ===== Simple UI helpers
  const statusEl = document.getElementById('status');
  function setStatus(t){ statusEl.textContent = 'Status: ' + t; }

  // ===== Register components
  AFRAME.registerComponent('game-manager', {
    init(){
      this.isGameOver = false;
      this.collected = 0;
      this.player = document.querySelector('#rig');
      this.hud = document.querySelector('.hud');
      this.black = this.makeOverlay();
      this.spawnCollectibles(7);
    },
    makeOverlay(){
      const o = document.createElement('div');
      o.style.cssText = 'position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;transition:opacity .6s;display:flex;align-items:center;justify-content:center;color:#fff;font:700 42px/1.1 system-ui;letter-spacing:.5px;z-index:20';
      o.textContent = 'GAME OVER';
      document.body.appendChild(o);
      return o;
    },
    gameOver(){
      if(this.isGameOver) return;
      this.isGameOver = true;
      setStatus('You were hit by a hazard!');
      this.black.style.opacity = '1';
      // disable movement
      const cam = document.getElementById('player');
      cam.removeAttribute('wasd-controls');
      cam.removeAttribute('look-controls');
    },
    spawnCollectibles(n){
      const parent = document.getElementById('collectibles');
      for(let i=0;i<n;i++){
        const e = document.createElement('a-entity');
        e.setAttribute('collectible','');
        e.setAttribute('position', `${randRange(-20,20)} ${randRange(0.7,1.2)} ${randRange(-20,20)}`);
        // Placeholder bottle - swap with model using gltf-model on this entity
        e.setAttribute('geometry','primitive: cylinder; radius: 0.08; height: 0.32');
        e.setAttribute('material','color: #9fd9ff; metalness: 0.2; roughness: 0.3; emissive: #002244; emissiveIntensity: 0.05');
        // cap
        const cap = document.createElement('a-entity');
        cap.setAttribute('position','0 0.18 0');
        cap.setAttribute('geometry','primitive: cylinder; radius: 0.06; height: 0.06');
        cap.setAttribute('material','color:#245b8a');
        e.appendChild(cap);
        parent.appendChild(e);
      }
    }
  });

  // Collectible component: disappears on touch
  AFRAME.registerComponent('collectible',{
    schema:{ radius:{default:0.45} },
    init(){ this.player = document.querySelector('#rig'); },
    tick(){
      if(!this.el.getAttribute('visible')) return;
      const p = new THREE.Vector3();
      const q = new THREE.Vector3();
      this.el.object3D.getWorldPosition(p);
      this.player.object3D.getWorldPosition(q);
      if(p.distanceTo(q) < this.data.radius){
        this.el.parentNode && this.el.parentNode.removeChild(this.el);
        setStatus('Collected a bottle!');
      }
    }
  });

  // Target spawner: drops a red ring, waits 3s, then check for hit.
  AFRAME.registerComponent('target-spawner',{
    schema:{ intervalMin:{default:4000}, intervalMax:{default:7000}, radius:{default:25} },
    init(){
      this.player = document.querySelector('#rig');
      this.game = document.querySelector('#game').components['game-manager'];
      this.timer = 0; this.nextAt = this.nextInterval();
    },
    nextInterval(){ return randRange(this.data.intervalMin, this.data.intervalMax); },
    tick(time,dt){
      if(this.game.isGameOver) return;
      this.timer += dt;
      if(this.timer >= this.nextAt){
        this.timer = 0; this.nextAt = this.nextInterval();
        this.spawnTarget();
      }
    },
    spawnTarget(){
      const x = randRange(-this.data.radius, this.data.radius);
      const z = randRange(-this.data.radius, this.data.radius);
      const y = 0.05; // just at surface
      const t = document.createElement('a-entity');
      t.setAttribute('position', `${x} ${y} ${z}`);
      t.setAttribute('target-marker','deadline: 3000');
      this.el.sceneEl.appendChild(t);
    }
  });

  // Target marker: visual red ring + countdown -> check for hit
  AFRAME.registerComponent('target-marker',{
    schema:{ deadline:{default:3000}, hitRadius:{default:1.2} },
    init(){
      const ring = document.createElement('a-entity');
      ring.setAttribute('geometry','primitive: torus; radius: 0.8; radiusTubular: 0.05; arc: 360');
      ring.setAttribute('material','color:#ff2b2b; emissive:#a10000; emissiveIntensity:0.6');
      ring.setAttribute('rotation','90 0 0');
      ring.setAttribute('animation','property: material.emissiveIntensity; dir: alternate; dur: 500; loop: true; to: 1.2');
      this.el.appendChild(ring);
      this.start = performance.now();
      this.player = document.querySelector('#rig');
      this.game = document.querySelector('#game').components['game-manager'];
      setStatus('Target appeared! Move away!');
    },
    tick(){
      if(this.game.isGameOver) return;
      const now = performance.now();
      if(now - this.start >= this.data.deadline){
        // Check if player inside hazard at the moment
        const p = new THREE.Vector3();
        const q = new THREE.Vector3();
        this.el.object3D.getWorldPosition(p);
        this.player.object3D.getWorldPosition(q);
        if(p.distanceTo(q) < this.data.hitRadius){
          this.game.gameOver();
        }
        this.el.parentNode && this.el.parentNode.removeChild(this.el);
        setStatus('Safe for now…');
      }
    }
  });
  </script>
</body>
</html>

